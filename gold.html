<!DOCTYPE html>
<html>
<head>
    <title></title>
    <link href="css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="js/fibseq.js"></script>
    <script type="text/javascript" src="js/tabulator.min.js"></script>
    <script src="js/vendor/jquery-1.11.3.min.js"></script>
    <script src="js/canvasjs.min.js"></script>
    <script src="js/papaparse.js"></script>
</head>
<body>
<div id="chartContainer" style="height: 370px; max-width: 920px; margin: 0px auto;"></div>
<div id="example-table"></div>
<script type="text/javascript">

    var drawData = [];
    var filteredData = [];
    var len = 0;

    Papa.parse('http://proape.cn/gold.csv', {
        download: true,
        complete: function(results) {
            len = results.data.length;
            if (len == 0) {
                return false;
            }
            var front;
            var count = 0;
            var bull = 0;
            var end;
            var end_count = 0;
            var end_bull = 0;
            for (var i = 0; i < len; i++) {
                front = results.data[i].filter(Boolean);
                if (front.length != 0) {
                    count += 1;
                    if (front[1] == 1) {
                        bull += 1;
                    }
                    drawData.push({x: count, y: parseFloat((bull/count * 100).toFixed(2))});
                }
                end = results.data[len - 1 - i].filter(Boolean);
                if (end.length != 0) {
                    end_count += 1;
                    if (end[1] == 1) {
                        end_bull += 1;
                    }
                    filteredData.unshift({
                        startDate: end[0],
                        real: end_count + '/' + end_bull + '/' + (end_count - end_bull),
                        realAll: end_count,
                        realBull: end_bull
                    });
                }
            }
            chart.render();
            getTableData();
        }
    });

    var chart = new CanvasJS.Chart("chartContainer", {
        animationEnabled: true,  
        title:{
            text: "Gold trade"
        },
        axisY: {
            title: "Bull Rate",
            /*stripLines: [{
                value: 3366500,
                label: "Average"
            }]*/
        },
        data: [{
            type: "spline",
            dataPoints: drawData
        }]
    });

    function getTableData() {
        var filterLen = filteredData.length;
        var fibKeys = Object.keys(fibObject);
        var base;
        var leftBull;
        var leftAll;
        var re = /(\d*)(\.0{1,2}|(\.[1-9])0)/;
        if (fibObject.hasOwnProperty(len)) {
            base = fibObject[fibObject[len].next];
        } else {
            fibKeys.forEach(function (i) {
                if (i > len && !base) {
                    base = fibObject[i];
                }
            });
        }
        console.log(base);
        if (filterLen == 0 || len == 0) {
            return false;
        }
        filteredData = filteredData.map(function (item) {
            if (item.realAll < base.prev) {
                base = fibObject[base.prev];
            }
            item.fib = (base.bull + base.bear) + '/' + base.bull + '/' + base.bear;
            leftBull = base.bull - item.realBull;
            leftAll = base.bull + base.bear - item.realAll;
            if (leftBull >= leftAll) {
                item.bull = 100;
            } else if (leftBull < 0) {
                item.bull = 0;
            } else {
                item.bull = (100 * leftBull / leftAll).toFixed(2);
            }
            item.bear = (100 - item.bull).toFixed(2);
            item.bull = String(item.bull).replace(re, '$1$3') + '%';
            item.bear = String(item.bear).replace(re, '$1$3') + '%';
            return item;
        });
        console.log(filteredData);
        var table = new Tabulator("#example-table", {
            //height:205,
            data:filteredData,
            layout:"fitColumns",
            columns:[
                {title:"StartDate", field:"startDate", width:150},
                {title:"Fib", field:"fib"},
                {title:"Real", field:"real"},
                {title:"Bull", field:"bull"},
                {title:"Bear", field:"bear"}
            ]
        });

    }
</script>
</body>
</html>
